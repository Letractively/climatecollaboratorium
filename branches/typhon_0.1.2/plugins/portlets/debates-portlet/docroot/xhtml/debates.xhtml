<?xml version="1.0"?>

<f:view xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://java.sun.com/jsf/core"
        xmlns:ice="http://www.icesoft.com/icefaces/component" xmlns:liferay-faces="http://liferay.com/tld/faces"
        xmlns:jsp="http://java.sun.com/JSP/Page" xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:t="http://myfaces.apache.org/tomahawk" xmlns:h="http://java.sun.com/jsf/html"
        xmlns:collab="http://climatecollaboratorium.org/components" xmlns:c="http://java.sun.com/jstl/core">
<ice:portlet id="debates-portlet">

<!-- for session timeout debugging -->
<div id="statusDiv"></div>


<script type="text/javascript">

    /* for session timeout debugging */

    Ice.onConnectionTrouble("mainContent", function() {
        //jQuery("#statusDiv").prepend("connectionTrouble " + new Date() + "<br />");
    });

    Ice.onSessionExpired("mainContent", function() {
        jQuery('#reloadPagePopup').hide();
        jQuery('#reloadPagePopup').dialog({resizable: false, title: "Session timed out", modal: true, width: 300, height: 170});
        jQuery('#reloadPagePopup').show();
        //jQuery("#statusDiv").prepend("sessionExpired " + new Date() + "<br />");
    });

    Ice.onConnectionLost("mainContent", function() {
        jQuery('#reloadPagePopup').hide();
        jQuery('#reloadPagePopup').dialog({resizable: false, title: "Session timed out", modal: true, width: 300, height: 170});
        jQuery('#reloadPagePopup').show();
        // jQuery("#statusDiv").prepend("connection lost " + new Date() + "<br />");
    });

    Ice.onAsynchronousReceive("mainContent", function() {
        // jQuery("#statusDiv").prepend("asynchronous receive "+ new Date() + "<br />");
    });


    jQuery(document).ready(function() {
    });

    function forceNav(debate, item) {
        jQuery("#navigationForm .debateId").val(debate);
        jQuery("#navigationForm .itemId").val(item);
        jQuery("#navigationForm .navSubmit").click();

    }

    function setFragment(debateId, debateItemId) {
        var currentFrag = getFragments();
        if (currentFrag) {

            if (currentFrag['debate'] == debateId &amp;&amp; debateItemId == currentFrag['item']) {
                return;
            }
        }
        var frag = debateId == null ? '' : ('#debate=' + debateId +
                (debateItemId == null ? '' : ';item=' + debateItemId));
        window.location.href = window.location.href.split("#")[0] + frag;
    }

    function getFragments() {
        var fragment = window.location.hash;
        if (fragment.length == 0) return false;
        var result = new Object();
        var segments = fragment.substring(1).split(";");
        jQuery.each(segments, function(idx, val) {
            if (val.indexOf("=") &lt; 1) return true;
            var entry = val.split("=");
            result[entry[0]] = entry[1];
        });
        return result;
    }

    function showAddLinkDialog() {
        try {
            jQuery('#addLinkDialog').slideDown();
            var text = jQuery('#debateItemLinkText').val('');
            var url = jQuery('#debateItemLinkUrl').val('http://');
            //                    jQuery('#addLinkDialog').dialog({resizable: false, title: "Add a link", modal: true, width: 230, height: 120});
            //                    jQuery('#addLinkDialog').show();
        }
        catch (err) {
            alert('error: ' + err);
        }

    }

    function closeAddLinkDialog(caller) {
        //jQuery(caller).parent().parent().parent().parent().parent().dialog('destroy');
        jQuery('#addLinkDialog').slideUp();
    }

    function addLink(caller) {
        var text = jQuery('#debateItemLinkText').val();
        var url = jQuery('#debateItemLinkUrl').val();
        var isValid = !jQuery.trim(text) == '' &amp;&amp; !jQuery.trim(url) == '';
        if (isValid) {
            var prevVal = jQuery('.debateItemContent').val();
            var linkCode = "&lt;a href=\"" + url + "\"&gt;" + text + "&lt;/a&gt; ";

            jQuery('.debateItemContent').val(prevVal + linkCode);
            //jQuery(caller).parent().parent().parent().parent().parent().dialog('destroy');
            jQuery('#addLinkDialog').hide();
        }
        else {
            alert('Provided values are invalid, all fields should contain values');
        }
    }

    function checkAddDebateItemReference() {

        jQuery('#referenceTextInput .validationError, #referenceUrlInput .validationError ').hide();

        var valid = true;
        var text = jQuery('#referenceTextInput input').val();
        var url = jQuery('#referenceUrlInput input').val();

        if (jQuery.trim(text) == "") {
            valid = false;
            jQuery('#referenceTextInput .validationError').show();
        }

        if (jQuery.trim(url) == "") {
            valid = false;
            jQuery('#referenceUrlInput .validationError').show();
        }

        return valid;
    }

    /** HISTORY MANAGEMENT STUFF */

    function pageload() {
        var frag = getFragments();
        if (!frag) {
            return;
        }
        forceNav(frag["debate"], frag["item"]);
    }

    jQuery(document).ready(function() {
        // Initialize history plugin.
        // The callback is called at once by present location.hash.
        jQuery.history.init(pageload);
    });

    /* this method should update address when item is added but doesn't work currently */
    function updateIfNew(debate, item) {
        /*var currentFrag = getFragments();
         if (currentFrag) {
         alert(currentFrag['debate'] + "\t" + currentFrag['item'] + "\n" + debate + "\t" + item);
         }
         */
    }

    function _debates_deferUntilLogin(fn) {
        if (Liferay.ThemeDisplay.isSignedIn()) {
            return true;
        } else {
            _user_info_showLoginPopup();
            return false;
        }
    }


</script>

<div class="hidden" id="reloadPagePopup" style="display: none">
    <div>
        Your session was interrupted, click on the button below to refresh the page
        (if you're in the course of adding / editing, click cancel and copy your work not to lose anything)<br/><br/>

        <div class="center">
            <input type="button" value="Reload" onclick="location.reload(true)"/>
            &amp;nbsp;&amp;nbsp;
            <input type="button" onclick="jQuery('#reloadPagePopup').dialog('close')" value="Cancel"/>
        </div>
    </div>
</div>

<div class="hidden" id="navigationForm" style="display: none">
    <ice:form id="myform">
        <ice:inputText value="#{portletNavigation.debate}" styleClass="debateId"/>
        <ice:inputText value="#{portletNavigation.item}" styleClass="itemId"/>
        <ice:commandButton actionListener="#{portletNavigation.navigateWithItem}" styleClass="navSubmit"/>
    </ice:form>

</div>


<div class="debateDetails">
    <ice:panelPopup rendered="#{editDebateItem.adding}" styleClass="collaboratoriumPopup" autoPosition="manual"
                    modal="true">
        <f:facet name="header">Add #{editDebateItem.type}</f:facet>
        <f:facet name="body">
            <f:subview id="debateItemDetails">
                <ui:include src="./debateItemEditView.xhtml"/>
                <div class="hidden">
                    <script language="javascript">
                       // jQuery(".collaboratoriumPopup").center();
                    </script>
                </div>
            </f:subview>
        </f:facet>
    </ice:panelPopup>

    <!-- suggest argument/position -->
    <ice:panelPopup rendered="#{suggestion.suggesting}" styleClass="collaboratoriumPopup" autoPosition="manual"
                    modal="true">
        <f:facet name="header">#{suggestion.header}</f:facet>
        <f:facet name="body">
            <ice:form>
                <div class="suggestionContent">
                    <div>
                        <h4>#{suggestion.text}</h4>

                        <p>Suggestions will be sent to the moderators for consideration.</p>
                        <ice:message styleClass="validationError" id="contentError" for="content"/>
                    </div>
                    <div class="suggestionInput">
                        <ice:inputTextarea id="content" value="#{suggestion.suggestion}" required="true"/>
                    </div>
                    <div class="buttonsContainer">
                        <ice:commandButton value="Cancel" partialSubmit="true"
                                           actionListener="#{suggestion.cancelAddSuggestion}"/>
                        <ice:commandButton value="Send" actionListener="#{suggestion.addSuggestion}"/>
                    </div>
                    <div class="clear"></div>
                </div>
            </ice:form>

        </f:facet>
    </ice:panelPopup>


    <div class="contentWrapperTop"></div>
    <div class="contentWrapperMiddle">
        <div class="header">
            <h2 class="debate-title">

                <span>Debates</span>
            </h2>
            <ice:outputConnectionStatus/>
        </div>


        <div class="content">
            <ice:panelStack selectedPanel="#{portletNavigation.selectedView}" styleClass="pageContainer">
                <ice:panelGroup id="Categories">
                    <ui:include src="./debateCategories.xhtml"/>
                </ice:panelGroup>
                <ice:panelGroup id="Detail">
                    <div class="topButtons">
                        <ice:form>


                            <ice:commandButton styleClass="subscriptionButton" value="Subscribe"
                                               action="#{debateDetails.subscribe}"
                                               rendered="#{permissions.canSubscribe and not empty debateDetails.selectedDebateItem and not debateDetails.subscribed}"/>
                            <ice:commandButton styleClass="subscriptionButton" value="Unsubscribe"
                                               action="#{debateDetails.unsubscribe}"
                                               rendered="#{permissions.canSubscribe and not empty debateDetails.selectedDebateItem and debateDetails.subscribed}"/>
                            <ice:commandButton styleClass="mappingModeButton" value="Advanced"
                                               action="#{debateDetails.showAdvanced}"
                                               rendered="#{permissions.canAddComment and not debateDetails.advanced}"/>
                            <ice:commandButton styleClass="mappingModeButton" value="Basic"
                                               action="#{debateDetails.showBasic}"
                                               rendered="#{permissions.canAddComment and debateDetails.advanced}"/>

                        </ice:form>
                        <ice:commandButton value="&lt;-- Back to index" action="#{portletNavigation.viewCategories}"
                                           onclick="setFragment(-1,-1);"/>

                        <div class="clear"></div>
                    </div>
                    <ice:form>
                        <div>

                            <collab:helpMessage messageId="test" styleClass="argumentHelp"
                                                hideThisMessage="Hide this message" defaultState="closed">
                                In debates, an <f:verbatim>&amp;nbsp;</f:verbatim><a
                                    href="/web/guest/resources/-/wiki/Main/Large+scale+argumentation">argument map</a> appears on the left.
                                Argument maps have four elements:
                                <ul>
                                    <li><span class="question"></span> an issue that is under debate</li>
                                    <li><span class="position"></span>positions on the issue</li>
                                    <li><span class="pro"></span>arguments for</li>
                                    <li><span class="con"></span>arguments against</li>
                                </ul>
                                You may click on any item in the map to view more detailed information about it. You are invited to vote (<span
                                    class="vote"></span>) for the position you believe is best.
                                A comment (<span
                                    class="comment"></span>) section appears on the right, where you may comment on any item in the argument map.
                                <br/><br/>
                                If you'd like to add to the argument map, you can click on the
                                <f:verbatim>&amp;nbsp;</f:verbatim><b>Advanced</b> button (on the upper right if you are logged in).
                            </collab:helpMessage>
                            <collab:helpMessageTrigger messageId="test">+show help</collab:helpMessageTrigger>

                            <div class="clear"></div>
                        </div>


                    </ice:form>


                    <ice:panelGroup rendered="#{empty portletNavigation.debate or portletNavigation.debate lt 0}">
                        Nothing to see here.
                    </ice:panelGroup>

                    <ice:panelGroup rendered="#{not empty portletNavigation.debate and portletNavigation.debate gt -1}">

                        <!--
                     <c:choose>
                         <c:when test="#{preferences.layout == 'COMMENTS_BELOW_ITEM_DETAILS'}">

                           <ice:panelDivider style="width: 100%; height: 100%;">
                               <f:facet name="first">
                                   <f:subview id="debateOutline">
                                       <ui:include src="./debateOutlineView.xhtml"/>
                                   </f:subview>
                               </f:facet>

                               <f:facet name="second">
                                   <f:subview id="debateItemDetails">
                                       <ui:include src="./debateItemDetailsView.xhtml"/>
                                   </f:subview>
                                   <f:subview id="debateCommentsRight">
                                       <ice:panelGroup styleClass="rightComments">
                                           <ui:include src="./debateCommentsView.xhtml" />
                                       </ice:panelGroup>
                                   </f:subview>
                               </f:facet>
                           </ice:panelDivider>
                       </c:when>
                       <c:otherwise>
                        -->
                        <ice:panelBorder id="page" renderNorth="false" renderCenter="true" renderWest="true"
                                         renderEast="true" renderSouth="#{debateDetails.selectedDebateItem != null}"
                                         styleClass="layoutPanel">
                            <f:facet name="west">
                                <f:subview id="debateOutline">
                                    <ui:include src="./debateOutlineView.xhtml"/>
                                </f:subview>
                            </f:facet>
                            <f:facet name="center">
                                &amp;nbsp;
                            </f:facet>
                            <f:facet name="east">
                                <ice:panelGroup
                                        styleClass="detailContainer #{preferences.layout == 'COMMENTS_BELOW_ITEM_DETAILS'?'combined':''}">
                                    <f:subview id="debateItemDetails">
                                        <ui:include src="./debateItemDetailsView.xhtml"/>

                                    </f:subview>
                                    <f:subview id="debateCommentsRight">
                                        <ice:panelGroup
                                                rendered="#{preferences.layout == 'COMMENTS_BELOW_ITEM_DETAILS'}"
                                                styleClass="rightComments">
                                            <ui:include src="./debateCommentsView.xhtml"/>
                                        </ice:panelGroup>
                                    </f:subview>
                                </ice:panelGroup>
                            </f:facet>
                            <f:facet name="south">
                                <f:subview id="debateCommentsBelow"
                                           rendered="#{preferences.layout == 'COMMENTS_BELOW_DEBATE_MAP'}">
                                    <ui:include src="./debateCommentsView.xhtml"/>
                                </f:subview>
                            </f:facet>
                        </ice:panelBorder>

                        <!--
                        </c:otherwise>
                        </c:choose>
                        -->
                    </ice:panelGroup>
                </ice:panelGroup>
            </ice:panelStack>
        </div>
    </div>
    <div class="contentWrapperBottom"></div>
</div>
</ice:portlet>
</f:view>
