<f:view 
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:collab="http://climatecollaboratorium.org/facelets"
    xmlns:ice="http://www.icesoft.com/icefaces/component"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:addthis="http://www.addthis.com/help/api-spec" >
    
    <ice:panelGroup rendered="#{planBean.leaveThisPlan}">
        <script type="text/javascript">
            var location = window.location.toString();
            location = location.substring(0, location.indexOf("/planId"));
                
            window.location = location;
        </script>
    </ice:panelGroup>

    <div class="headline addprop">
        Nullam id dolor id nibh ultricies vehicula ut id elit. Praesent commodo cursus magna, vel scelerisque nisl consectetur et. Lorem ipsum dolor sit amet, consectetur adipiscing elit.<br />
        <a href="javascript:;">Read the contest rules</a>
    </div> <!-- /headline -->

    <ice:form styleClass="addpropform">
    <div class="prop-left" id="addpropform">
        <div class="addpropbox q1">
            <label>
                <strong>Title</strong> 
                <a class="helpTrigger" href="javascript:;"><img src="/climatecolab-theme/images/icon-addprop-question.png" width="15" height="15" /></a><br />
                40 characters
            </label>
            <div class="addprophelp">Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum ultricies vehicula ut id elit. magnis dis parturient montes, nasceturnibh, ut fermentum massa justo sit amet risus. Nullam id dolor id nibh  ridiculus mus lorem dolor sit amet.</div>
            <div class="addpropInputContainer">
                <ice:inputText value="#{plan.plan.name}" onchange="jQuery(this).addClass('valueChanged');" required="true" >
                    <f:attribute name="plan" value="#{plan.plan}"/>
                    <f:validator validatorId="planNameValidator"/>
                    <f:attribute name="planName" value="#{plan.plan.name}" />
                </ice:inputText>
                <div class="inputLimitContainer"><span class="limit_characterCount"></span>/&amp;nbsp;<span class="limit_charactersMax">40</span> characters</div>
                <div style="display: none">
                    <textarea class="originalValue">#{plan.plan.originalName}</textarea>
                </div>
            </div>
        </div>
        <div class="addpropbox blue q2">
            <label>
                <span>Team name<br />
                <em>optional</em></span> 
                <a class="helpTrigger" href="javascript:;"><img src="/climatecolab-theme/images/icon-addprop-question.png" width="15" height="15" /></a><br />
                20 characters
            </label>
            <div class="addprophelp">Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum ultricies vehicula ut id elit. magnis dis parturient montes, nasceturnibh, ut fermentum massa justo sit amet risus. Nullam id dolor id nibh  ridiculus mus lorem dolor sit amet.</div>
            <div class="addpropInputContainer">
                <ice:inputText value="#{proposal.plan.team}" />
                <div class="inputLimitContainer"><span class="limit_characterCount"></span>/&amp;nbsp;<span class="limit_charactersMax">20</span> characters</div>
                <div style="display: none">
                    <textarea class="originalValue">#{plan.plan.originalTeam}</textarea>
                </div>
            </div>
        </div>
        
        <div class="notation">Note: If you enter a team name, it will replace the proposal owner's name in the Author field.</div>
        
        <div class="addpropbox blue">
            <label>
                <span>Proposal image<br />
                <em>optional</em></span>
            </label>
            <ice:panelGroup styleClass="upload proposalImageUpload">
                    <div class="uploadbox">
                        <f:subview rendered="#{not empty proposal.plan.image}">
                            <img src="#{proposal.plan.image}" width="50px" height="50px"/>
                        </f:subview>
                    </div>
                            
                    <div id="uploadWidget">
                        <ice:inputFile actionListener="#{proposal.plan.uploadImage}" styleClass="filepc" autoUpload="true" >
                            <ice:outputStyle href="/css/proposals.css" />
                        </ice:inputFile><br />
                    </div>
                    
                    <ice:commandLink styleClass="hidden signalPictureUploaded" actionListener="#{proposal.plan.signalPictureUploaded}" />
                    
                    <script type="text/javascript">
                        monitorUploadFrame();
                    </script>
            </ice:panelGroup>
        </div>

        <div class="addpropbox q3">
            <label>
                <strong>Pitch</strong> 
                <a href="javascript:;" class="helpTrigger"><img src="/climatecolab-theme/images/icon-addprop-question.png" width="15" height="15" /></a><br />
                140 characters
            </label>
            <div class="addprophelp">Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum ultricies vehicula ut id elit. magnis dis parturient montes, nasceturnibh, ut fermentum massa justo sit amet risus. Nullam id dolor id nibh  ridiculus mus lorem dolor sit amet.</div>
            <div class="addpropInputContainer">
                <ice:inputTextarea value="#{proposal.plan.abstract}" cols="50" rows="7" style="display: inline;"/>
                <div class="inputLimitContainer">
                    <span class="limit_characterCount"></span>/&amp;nbsp;<span class="limit_charactersMax">140</span> characters
                </div>
                <div style="display: none">
                    <textarea class="originalValue">#{plan.plan.originalAbstract}</textarea>
                </div>
            </div>
        </div>
        
        <!--  if proposal has sections - render edit forms for sections -->
        <f:subview rendered="#{proposal.plan.hasSections}">
            <ice:panelSeries var="section" value="#{proposal.plan.sections}">
                <div class="addpropbox q3">
                    <label>
                        <strong>#{section.section.definition.title}</strong> 
                        <a href="javascript:;" class="helpTrigger"><img src="/climatecolab-theme/images/icon-addprop-question.png" width="15" height="15" /></a><br />
                        <f:subview rendered="#{section.section.definition.characterLimit gt 0}">
                            #{section.section.definition.characterLimit} characters
                        </f:subview>
                         
                    </label>
                    <div class="addprophelp">#{section.section.definition.helpText}</div>
                    <div class="addpropInputContainer">
                        <ice:inputTextarea value="#{section.section.content}" cols="50" rows="7" styleClass="rte" />
                        <f:subview rendered="#{section.section.definition.characterLimit gt 0}">
                            <div class="inputLimitContainer">
                                <span class="limit_characterCount"></span>/&amp;nbsp;<span class="limit_charactersMax">#{section.section.definition.characterLimit}</span> characters
                            </div>
                        </f:subview>
                        <div style="display: none">
                            <textarea class="originalValue">#{section.originalContent}</textarea>
                        </div>
                    </div>
                </div>
            </ice:panelSeries>
        </f:subview>
        
        <f:subview rendered="#{not proposal.plan.hasSections}">
            <div class="addpropbox">
                <label>
                    <strong>Description</strong> 
                    <a href="javascript:;" class="helpTrigger"><img src="/climatecolab-theme/images/icon-addprop-question.png" width="15" height="15" /></a><br />
                </label>
                <div class="addprophelp">Enter proposal assumptions, actions, describe your ideas.</div>
                <div class="addpropInputContainer">
                    <ice:inputTextarea value="#{proposal.plan.description}" cols="50" rows="20" styleClass="rte" />
                    <div style="display: none">
                        <textarea class="originalValue">#{plan.plan.originalDescription}</textarea>
                    </div>
                </div>
            </div>
        </f:subview>
        
        
   
        
        <script>
        try {
            jQuery("#addpropform .helpTrigger").click(function() {
                var trigger = jQuery(this);
                trigger.parent().parent().find(".addprophelp").slideToggle("fast");
            });
            
            
            var counter = 0;
            
            function shouldAllowMoreCharacters(input) {
                if (typeof(input.attr('validateLength')) == 'undefined' || typeof(input.attr('maxCharacters')) == 'undefined' || input.attr('maxCharacters') + 0 &lt;= 0) {
                    return true;
                }
                return input.attr('maxCharacters') > input.val().length;
            }
            
            function updateCharacterCounter(input) {
                var elem = input.get(0);
                var max = input.attr('maxCharacters');
                if (input.val().length >= 1 * max) {
                    elem.limitCharacterCounter.parent().addClass('overflow');
                }
                else {
                    elem.limitCharacterCounter.parent().removeClass('overflow');
                }
                elem.limitCharacterCounter.text(input.val().length);
            }
            
            
            jQuery("input[type='text'], textarea").each(function() {
                if (jQuery(this).hasClass('rteInitialized')) {
                    return;
                }
                
                var tmp = this;
                var thiz = jQuery(this);
                
                var limitCharactersMax = thiz.parent().find(".limit_charactersMax");
                var limitCharacterCount = thiz.parent().find(".limit_characterCount");
                
                
                
                if (limitCharactersMax.length > 0) {
                    thiz.attr({maxCharacters: limitCharactersMax.text(), validateLength: true});
                    this.limitCharacterCounter = limitCharacterCount;
                    updateCharacterCounter(thiz);
                }
                else {
                    thiz.attr({validateLength: false});
                }
                
                eventsToBind = {
                            keypress: function(event) {
                                if (! shouldAllowMoreCharacters(thiz)) {
                                    event.preventDefault();
                                }
                                if (thiz.attr('validateLength') &amp;&amp; tmp.limitCharacterCounter) {
                                    updateCharacterCounter(thiz);
                                }
                            },
                            keyup: function(event) {
                                if (thiz.attr('validateLength') &amp;&amp; tmp.limitCharacterCounter) {
                                    updateCharacterCounter(thiz);
                                }
                            }
                        };
                if (thiz.hasClass("rte")) {
                    thiz.wysiwyg({
                        css: '/climatecolab-theme/css/style.css', 
                        events: eventsToBind,
                        rmUnusedControls: true,
                        dialog:"jqueryui",
                        controls: {
                            bold: { visible : true }, italic: {visible: true}, underline: {visible: true}, 
                            insertOrderedList: {visible: true}, insertUnorderedList: {visible: true},
                            insertImage: {visible: true}, createLink: {visible: true}
                        }
                    });
                }
                else {
                    thiz.bind(eventsToBind);
                }
                
 
                jQuery(this).addClass('rteInitialized');
                
                
            });
            
            }
            catch(e) {
                alert(e);
            }
        </script>
        
        
     
    </div>
    
    <ui:include src="./widget_PROPOSAL_SUMMARY.xhtml" />
    
    <script>
        window.showAcceptTosPopup = function() {
            jQuery("#acceptTosPopup").fadeIn("fast");
            
        }
        
        window.closeAcceptTosPopup = function() {
            jQuery("#acceptTosPopup").fadeOut("fast");
            
        }
        
        window.tosAcceptedSave = function() {
            jQuery("#forceSaveButton a").click();
            jQuery("#acceptTosPopup").fadeOut("fast");
            
        }
    </script>
    
    
<div id="acceptTosPopup" style="position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: 100; display: none; ">
<div class="popup-wrap p1" id="acceptTosPopup">
 <div class="popup">
  <h4>By saving your proposal you are entering the Climate CoLab contest and agree to the Contest Rules and  Terms of Use:</h4>
  <div class="terms">
    #{preferences.defaultDescription}
  </div>
  <div class="btns">
   <div class="blue-button"><a href="javascript:;" onclick="tosAcceptedSave();" class="cp1-1">ACCEPT</a></div> <div class="gray-button"><a href="javascript:;" class="cp1-2" onclick="closeAcceptTosPopup();">DO NOT Accept</a></div>
  </div>
 </div>
</div>
</div>
    
    <div class="admin-overlay-wrap">
        <div class="admin-overlay">
            <div class="inner">
                <div class="admin-left">
                    <p>
                        <f:subview rendered="#{proposal.plan.version le 1}">
                            You are currently editing a new proposal
                        </f:subview>
                        <f:subview rendered="#{proposal.plan.version gt 1}">
                            You are editing a proposal
                        </f:subview>
                    <br />
                    "#{proposal.plan.name}"</p>
                    <div class="blue-button"><ice:commandLink value="SAVE changes" actionListener="#{proposal.plan.saveContent}" onclick="if (#{proposal.plan.version} &lt;= 1) {window.showAcceptTosPopup(); return false; }" /></div> 
                    <div class="gray-button"><ice:commandLink value="DISCARD changes" actionListener="#{proposal.toggleEditing}" /></div>
                </div>
                <div class="admin-right">
                    <p>&amp;nbsp;</p>
                </div>
            </div>
        </div>
</div>
    <div id="forceSaveButton" style="display: none;">
        <ice:commandLink value="SAVE changes" actionListener="#{proposal.plan.saveContent}" style="display: none;" />
    </div>
    
        <ice:panelGroup styleClass="hidden ">
            <script type="text/javascript">
                Collab.nav.addEditorDirtyValidationCallback(checkIfPlanDescriptionDirty);
                initiailzeEditTrigger(#{permissions.loggedIn}, #{permissions.canEdit}, #{permissions.planEditable},true);
            </script>
        </ice:panelGroup>
        
    
        </ice:form>
 </f:view>